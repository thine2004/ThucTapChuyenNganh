<div class="container-xxl py-5">
    <div class="container">
        <div class="text-center wow fadeInUp" data-wow-delay="0.1s">
            <h6 class="section-title bg-white text-center text-primary px-3">Chương trình học</h6>
            <h1 class="mb-5">{{course.title}}</h1>
        </div>
        <div class="row g-4">
            {{#each lessons}}
            <div class="col-lg-4 col-md-6 wow fadeInUp" data-wow-delay="0.1s">
                <div class="service-item text-center pt-3 h-100">
                    <div class="p-4">
                        <i class="fa fa-3x fa-play-circle text-primary mb-4"></i>
                        <h5 class="mb-3">{{this.title}}</h5>
                        <div class="mb-3">
                            <span class="badge bg-light text-dark border">{{this.duration}} phút</span>
                            {{#if this.isFree}}
                            <span class="badge bg-success">Học thử</span>
                            {{/if}}
                        </div>
                        {{!-- Button triggers modal --}}
                        <button type="button" 
                                class="btn btn-outline-primary rounded-pill px-4 mt-2 btn-play-video"
                                data-bs-toggle="modal" 
                                data-bs-target="#videoModal"
                                data-video-url="{{this.videoUrl}}"
                                data-video-title="{{this.title}}">
                            Vào học
                        </button>
                    </div>
                </div>
            </div>
            {{else}}
            <div class="col-12 text-center py-5">
                <p class="text-muted">Chưa có bài học nào được cập nhật cho khóa học này.</p>
            </div>
            {{/each}}
        </div>
        
        <div class="text-center mt-5">
             <a href="/profile" class="btn btn-secondary rounded-pill px-4"><i class="fa fa-arrow-left me-2"></i>Quay lại Hồ sơ</a>
        </div>
    </div>
</div>

<!-- Video Modal -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="videoModalLabel">Xem bài học</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="ratio ratio-16x9">
            <iframe id="videoFrame" src="" title="Video bài học" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var videoModal = document.getElementById('videoModal');
    var videoFrame = document.getElementById('videoFrame');
    var modalTitle = document.getElementById('videoModalLabel');

    videoModal.addEventListener('show.bs.modal', function (event) {
        // Button that triggered the modal
        var button = event.relatedTarget;
        // Extract info from data-* attributes
        var videoUrl = button.getAttribute('data-video-url');
        var title = button.getAttribute('data-video-title');
        
        // Update the modal's content.
        modalTitle.textContent = title;

        // Process URL to get embed format if it's Youtube
        var embedUrl = videoUrl;
        var youtubeId = getYoutubeId(videoUrl);
        if (youtubeId) {
            embedUrl = 'https://www.youtube.com/embed/' + youtubeId + '?autoplay=1';
        }
        
        videoFrame.src = embedUrl;
    });

    // Clear video source on close to stop playing
    videoModal.addEventListener('hidden.bs.modal', function (event) {
        videoFrame.src = '';
    });

    function getYoutubeId(url) {
        if (!url) return null;
        var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        var match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }
});
</script>
